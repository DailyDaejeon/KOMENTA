<template>
    <div class="container margin__left">
        <div class="container__following">
            <!-- 버튼 누르기 -->
            <div class="btn-cover_people">
                <button :disabled="pageNum === 0" @click="prevPage" class="page-btn_people">
                    <font-awesome-icon :icon="['fas', 'angle-left']"/>
                </button>
            <!-- 프로필 팔로잉 사진 목록 -->
            <div class="container__following__Profle">
                <div v-for="(user,index) in paginatedData" :key="index"> {{user}}
                    <div @click="gotoFeed(user)" class="container__following__Profle__background"><img :src="getUpdateProfile(user)" class="container__following__Profle__img" width="100px" height="100px"></div>
                    <div class="container__following__Profle__NEW">NEW!</div>
                </div>
            </div>
            <button :disabled="pageNum >= pageCount-1" @click="nextPage" class="page-btn_people">
                <font-awesome-icon :icon="['fas', 'angle-right']"/>
            </button>
            </div>
            
            <!-- 친구 카드 프로필 닉네임 같이 보여주면서 바로가기 -->
            <div class="at-section">
                <div class="at-section__title"><span class="at-section__nickname">{{userInfo.u_nickname}}</span>님의 친구들의 피드에서 소식을 확인해보세요</div>
                <span class="at-section__subtitleButton"><span class="at-section__subtitle"><i class="fas fa-check at-section__icon"></i>친구들의 플레이리스트를 확인하고, 취향에 맞는 VOD를 추천받아보세요!</span></span>
            </div>
            <div class="btn-cover_people">
                <button :disabled="pageNum_2 === 0" @click="prevPage_2" class="page-btn_people" style="margin: 4.5rem 2rem">
                    <font-awesome-icon :icon="['fas', 'angle-left']"/>
                </button>
            <div class="at-grid basic-scroll">
                <div class="at-column" v-for="(user,index) in paginatedData_people" :key="index">
                    <div class="at-user"  @click="gotoFeed(user.f_id)">
                        <div class="at-user__name">{{user.u_nickname}}</div>
                        <div class="at-user__profile"><img :src="getProfile(index)" width="50px" height="50px" class="at-user__profile__img"></div>
                    </div>
                </div>
            </div>
            <button :disabled="pageNum_2 >= pageCount_2 -1" @click="nextPage_2" class="page-btn_people" style="margin: 4.5rem 2rem">
                <font-awesome-icon :icon="['fas', 'angle-right']"/>
            </button>
            </div>
            
            <!-- 업데이트된 플레이리스트 카드형태로 2개씩 보여줌 -->
            <div class="at-section">
                <div class="at-section__title"><span class="at-section__nickname" style="font-size:2.8rem">새롭게 업데이트된 플레이리스트를 확인해보세요</span></div>
                <span class="at-section__subtitleButton"><span class="at-section__subtitle"><i class="fas fa-check at-section__icon"></i>최근 일주일 간 업데이트된 친구의 플레이리스트 보러가기</span></span>
            </div>

            <div class="playlist">
                <div v-for="(playlist,index) in updateFollowPlaylist" :key="index" class="playlist__box">
                    <div>
                        <div @click="gotoPlaylist(playlist[0].pl_id)"><img :src="getPoster(index)" width="50px" height="50px" class="playlist__box__img"></div>
                        <div class="playlist__box__info">
                            <div class="playlist__box__info__plname">{{playlist[0].pl_name}}</div>
                            <button class="playlist__box__info__nickname" @click="gotoFeed(playlist[0].u_id)"> {{ nickname_array[index] }}</button>
                            <div class="playlist__box__info__comment">{{playlist[0].pl_comment}}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import { fetchfollowinglist,updateFollowPlaylist,fetchMyInfo } from '@/api/user'
// import { mapState } from 'vuex'
import store from '@/stores/modules/user'

export default {
    data() {
        return {
            pageNum:0,
            pageNum_2:0,
            following_list:[],
            updateFollowPlaylist:[],
            updateProfile:[],
            playlist_nickname:[],
            nickname_array : [],
        }
    },
    props: {
        pageSize: {
            type: Number,
            required: false,
            default: 7
        },
        pageSize_2: {
            type: Number,
            required: false,
            default: 5
        }
    },
    computed: {
        userInfo() {
            return store.state.userInfo;
        },
        pageCount() {
            let listLeng = this.updateProfile.length,
            listSize = this.pageSize,
            page = Math.floor(listLeng / listSize);

            if(listLeng % listSize > 0) page += 1;

            return page;
        },
        pageCount_2() {
            let listLeng_2 = this.following_list.length,
            listSize_2 = this.pageSize_2,
            page_2 = Math.floor(listLeng_2 / listSize_2);

            if(listLeng_2 % listSize_2 > 0) page_2 += 1;

            return page_2;
        },
        paginatedData() {
            const start = this.pageNum * this.pageSize,
            end = start + this.pageSize;
            console.log(this.updateProfile,'너는 어떻닝')
            return this.updateProfile.slice(start, end);
            
        },
        paginatedData_people() {
            const start_2 = this.pageNum_2 * this.pageSize_2,
            end_2 = start_2 + this.pageSize_2;

            return this.following_list.slice(start_2, end_2);
        },
        
    },
    created() {
        this.getFollowing()
        this.getUpdateFollowPlaylist()
        this.getNickname()
    },
    methods: {
        gotoFeed(userId) {
            this.$router.push(`/feed/${userId}`)
        },
        gotoPlaylist(plId){
            this.$router.push(`/playlist/${plId}`)
        },
        nextPage() {
            this.pageNum += 1;
        },
        prevPage() {
            this.pageNum -= 1;
        },
        nextPage_2() {
            this.pageNum_2 += 1;
        },
        prevPage_2() {
            this.pageNum_2 -=1;
        },
        getProfile(index) {
            const profile = this.following_list[index].u_profile_pic.split('.')[0]
            console.log(`${process.env.VUE_APP_PICTURE}profile/${profile}`)
            return `${process.env.VUE_APP_PICTURE}profile/${profile}`;
        },
        getUpdateProfile(userId) {
            for (let i = 0; i < this.following_list.length; i++) {
                console.log(userId,this.following_list[i].u_id,'프로필가져왓')
               if (userId == this.following_list[i].u_id){
                   const profile = this.following_list[i].u_profile_pic.split('.')[0]
                //    console.log(profile,'??')
                   return `${process.env.VUE_APP_PICTURE}profile/${profile}`;
               }
            }
            return 
        },
        getPoster(index) {
            const poster = this.updateFollowPlaylist[index][0].v_poster
            return `${process.env.VUE_APP_PICTURE}poster/${poster}`;
        },
        // 이미 있는 updateFollowPlaylist로 nickname 배열 만들기
        async getNickname() {
            for (let index = 0; index < this.updateFollowPlaylist.length; index++) {
                const element = this.updateFollowPlaylist[index][0].u_id;
                const response = await fetchMyInfo(element)
                this.nickname_array.push(response.data.u_nickname)
            }
        },

        async getUpdateFollowPlaylist() {
            const response = await updateFollowPlaylist()
            this.updateFollowPlaylist = response.data
            for (let index = 0; index < this.updateFollowPlaylist.length; index++) {
                const element = this.updateFollowPlaylist[index];
                console.log(element,'????')
                if (this.updateProfile.includes(element[0].u_id)) {
                    console.log(element[0].u_id,'오잉')
                } else {
                    this.updateProfile.push(element[0].u_id)
                    console.log(this.updateProfile,'ㅋㅋ과연')
                }
                
            } 

            this.getNickname();
        },
        async getFollowing() {
            const userId = store.state.userInfo.u_id
            const response = await fetchfollowinglist(userId)
            this.following_list = response.data
        },
    },
}
</script>

<style>

